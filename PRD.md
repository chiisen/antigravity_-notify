# PRD: Antigravity 核准通知系統

## 1. 產品概述

| 項目 | 內容 |
|------|------|
| **產品名稱** | Antigravity Notify |
| **產品類型** | 通知與審批系統 |
| **核心功能** | 監控 Antigravity AI IDE 執行狀態，當需要使用者核准時透過 Telegram 發送通知，並支援直接回覆核准 |
| **目標使用者** | 使用 Antigravity IDE 的開發者 |

---

## 2. 背景與動機

Antigravity AI IDE 在執行過程中會有需要使用者確認或核准的場景（如：代碼審查、風險操作確認、敏感權限請求）。目前缺乏主動通知機制，導致使用者必須持續盯著 IDE 畫面，降低工作效率。

本系統旨在：
- **即時通知**：不漏接任何核准請求
- **快速回應**：透過 Telegram 直接核准，無需切換上下文
- **完整記錄**：留存所有操作軌跡與日誌

---

## 3. 使用者故事

| 編號 | 使用者故事 | 優先級 |
|------|-----------|--------|
| 作為開發者，當 Antigravity 需要核准時，我希望透過 Telegram 收到通知，這樣我就不需要一直盯著 IDE 畫面 | P0 |
| 作為開發者，我希望直接回覆 Telegram 訊息來核准，這樣可以快速回應而不需要切換到 IDE | P0 |
| 作為開發者，我希望查看歷史核准記錄，方便稽核與問題排查 | P1 |
| 作為開發者，我希望系統能區分不同類型的核准請求，讓我能快速判斷優先級 | P2 |

---

## 4. 功能需求

### 4.1 日誌監控 (Log Monitoring)

- [ ] **日誌來源**：監控 Antigravity 的執行日誌檔案或 stdout/stderr 輸出
- [ ] **日誌格式解析**：辨識「需要核准」的关键字或事件（如 `approval_required`, `confirm_action`, `risk_warning`）
- [ ] **狀態追蹤**：持續監控日誌變化，偵測新事件

### 4.2 Telegram 通知

- [ ] **Bot 設定**：建立 Telegram Bot，取得 API Token
- [ ] **認證綁定**：使用者透過 /start 命令綁定 Telegram Chat ID
- [ ] **訊息格式**：
  - 標題：核准類型（如：代碼審查、風險操作）
  - 內容：請求摘要、相關檔案、操作說明
  - 按鈕：快速核准/拒絕（透過 Inline Keyboard）

### 4.3 核准回覆機制

- [ ] **指令回覆**：支援回覆訊息內容（如回覆「yes」或「approve」）
- [ ] **Inline 按鈕**：提供「✅ 核准」與「❌ 拒絕」按鈕
- [ ] **核准驗證**：確認操作安全性（可選：設定白名單指令）

### 4.4 記錄與查詢

- [ ] **歷史記錄**：儲存所有通知與回覆歷史（SQLite/檔案）
- [ ] **查詢指令**：/history 查看歷史記錄
- [ ] **匯出功能**：匯出為 JSON/CSV（可選）

---

## 5. 非功能需求

| 項目 | 需求 |
|------|------|
| **延遲** | 通知延遲 < 3 秒 |
| **可靠性** | 支援離線重連，日誌監控不漏失 |
| **安全性** | Telegram Bot Token 需加密儲存，核准動作需二次確認（可選） |
| **擴展性** | 支援多個專案配置 |

---

## 6. 技術架構建議

### 6.1 技術選型

| 層面 | 技術 |
|------|------|
| **監控核心** | Go 1.21+ (goroutine + channel) |
| **日誌監控** | fsnotify (檔案監控) + bufio.Scanner (tail 風格) |
| **訊息傳遞** | go-telegram-bot-api 或 telebot |
| **資料儲存** | SQLite (modernc.org/sqlite) 或 BoltDB |
| **部署方式** | 單一二進制 + 系統服務（systemd / launchd）或 Docker |

### 6.2 系統架構圖

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│ Antigravity IDE │────▶│ Log Monitor      │────▶│ Telegram Bot│
│ (日誌輸出)       │     │ (Go Binary)      │     │   (HTTP)    │
└─────────────────┘     └────────┬─────────┘     └──────┬──────┘
                                 │                      │
                        ┌────────▼────────┐             │
                        │ Approval Handler │◀────────────┘
                        │ (goroutine)      │
                        └────────┬────────┘
                                 │
                        ┌────────▼────────┐
                        │ SQLite / BoltDB │
                        │ (歷史記錄)       │
                        └─────────────────┘
```

---

## 7. 實作里程碑

| 階段 | 內容 | 預估天數 |
|------|------|----------|
| Phase 1 | 基本日誌監控 + Telegram 通知 | 1-2 天 |
| Phase 2 | 核准回覆機制（指令/按鈕） | 1-2 天 |
| Phase 3 | 歷史記錄與查詢功能 | 1 天 |
| Phase 4 | 安全性強化、部署包裝 | 1 天 |

---

## 8. 風險與假設

| 風險 | 緩解措施 |
|------|----------|
| Antigravity 日誌格式未知 | 先建立通用的 tail + regex 監控，可彈性調整 |
| Telegram Bot API 限制 | 遵守速率限制，設計重試機制 |
| 核准操作不可逆 | 設計「二次確認」機制，預設拒絕危險操作 |

---

## 9. 待確認事項

- [ ] Antigravity 的日誌檔案路徑或輸出方式為何？
- [ ] 需要支援哪些類型的核准請求？
- [ ] 核准後的實際操作如何觸發？（透過 API？檔案修改？）

---

**文件版本**：v1.0  
**建立日期**：2026-02-26  
**作者**：AI Assistant
